<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Senhas</title>
    <script src="https://cdn.tailwindcss.com"></script>


</head>

<body class="bg-gray-900 text-white h-screen flex">

<!-- COLUNA ESQUERDA (SENHA ATUAL) -->
<div class="w-2/3 flex flex-col items-center justify-center gap-6">

    <h1 class="text-4xl font-bold tracking-widest text-gray-300">Chamando Agora</h1>

    <div class="text-[10rem] font-black text-yellow-400 blink" id="senha-atual">
        --
    </div>

    <div id="tipo-senha" class="text-2xl text-gray-400 font-semibold">
        Aguardando...
    </div>

</div>

<!-- COLUNA DIREITA (HISTÓRICO) -->
<div class="w-1/3 bg-gray-800 p-6 flex flex-col">

    <h2 class="text-gray-400 font-bold tracking-wider text-sm mb-4 uppercase">
        Últimas Chamadas
    </h2>

    <div id="historico" class="flex-1 space-y-3 overflow-auto text-lg">
        <p class="text-gray-600 text-sm">Nenhum histórico ainda</p>
    </div>

</div>

<!-- ÁUDIO -->
<audio id="som" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
    const API_URL = "http://localhost:8080/senhas";
    let ultimaSenha = "";

    async function buscarSenhaAtual() {
        try {
            const resp = await fetch(API_URL + "/atual");
            if (!resp.ok) return;

            const senha = await resp.json();
            if (!senha) return;

            if (senha.numero !== ultimaSenha) {
                atualizarTela(senha);
            }
        } catch (e) {
            console.warn("Backend offline");
        }
    }

    function atualizarTela(senha) {
        document.getElementById("senha-atual").innerText = senha.numero;
        document.getElementById("tipo-senha").innerText =
            senha.tipo === "PREFERENCIAL" ? "Preferencial" : "Geral";

        adicionarHistorico(ultimaSenha, senha.tipo);
        ultimaSenha = senha.numero;

        // Toca som
        const audio = document.getElementById("som");
        audio.currentTime = 0;
        audio.play().catch(() => {});
    }

    function adicionarHistorico(numero, tipo) {
        if (!numero || numero === "--") return;

        const lista = document.getElementById("historico");

        // Remove texto "vazio"
        if (lista.innerText.includes("Nenhum")) lista.innerHTML = "";

        const item = document.createElement("div");
        item.className = "bg-gray-700 rounded-lg p-3 flex justify-between items-center";

        item.innerHTML = `
            <span class="font-bold">${numero}</span>
            <span class="text-sm ${tipo === 'PREFERENCIAL' ? 'text-red-300' : 'text-blue-300'}">
                ${tipo === "PREFERENCIAL" ? "Prioritário" : "Geral"}
            </span>
        `;

        // adiciona no topo
        lista.prepend(item);

        // limite de 5 itens
        while (lista.children.length > 5) {
            lista.lastChild.remove();
        }
    }

    // Busca a cada 2s
    setInterval(buscarSenhaAtual, 2000);
    buscarSenhaAtual();
</script>

</body>
</html>
